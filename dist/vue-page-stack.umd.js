(function(s,u){typeof exports=="object"&&typeof module<"u"?module.exports=u(require("vue"),require("vue-router")):typeof define=="function"&&define.amd?define(["vue","vue-router"],u):(s=typeof globalThis<"u"?globalThis:s||self,s.VuePageStack=u(s.Vue))})(this,function(s){"use strict";const u={componentName:"VuePageStack",keyName:"stack-key",pushName:"push",goName:"go",replaceName:"replace",backName:"back",forwardName:"forward"},m={action:u.pushName};let O;const h=new Uint8Array(16);function g(){if(!O&&(O=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!O))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return O(h)}const r=[];for(let n=0;n<256;++n)r.push((n+256).toString(16).slice(1));function D(n,e=0){return r[n[e+0]]+r[n[e+1]]+r[n[e+2]]+r[n[e+3]]+"-"+r[n[e+4]]+r[n[e+5]]+"-"+r[n[e+6]]+r[n[e+7]]+"-"+r[n[e+8]]+r[n[e+9]]+"-"+r[n[e+10]]+r[n[e+11]]+r[n[e+12]]+r[n[e+13]]+r[n[e+14]]+r[n[e+15]]}const U={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function H(n,e,c){if(U.randomUUID&&!e&&!n)return U.randomUUID();n=n||{};const o=n.random||(n.rng||g)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,e){c=c||0;for(let E=0;E<16;++E)e[c+E]=o[E];return e}return D(o)}var N;(function(n){n[n.ELEMENT=1]="ELEMENT",n[n.FUNCTIONAL_COMPONENT=2]="FUNCTIONAL_COMPONENT",n[n.STATEFUL_COMPONENT=4]="STATEFUL_COMPONENT",n[n.TEXT_CHILDREN=8]="TEXT_CHILDREN",n[n.ARRAY_CHILDREN=16]="ARRAY_CHILDREN",n[n.SLOTS_CHILDREN=32]="SLOTS_CHILDREN",n[n.TELEPORT=64]="TELEPORT",n[n.SUSPENSE=128]="SUSPENSE",n[n.COMPONENT_SHOULD_KEEP_ALIVE=256]="COMPONENT_SHOULD_KEEP_ALIVE",n[n.COMPONENT_KEPT_ALIVE=512]="COMPONENT_KEPT_ALIVE",n[n.COMPONENT=6]="COMPONENT"})(N||(N={}));const y=(n,e)=>{for(let c=0;c<n.length;c++)n[c](e)};function A(n,e,c,o){s.callWithAsyncErrorHandling(n,e,M.VNODE_HOOK,[c,o])}const S=n=>n.__isSuspense,V={ENTER:0,LEAVE:1,REORDER:2},M={SETUP_FUNCTION:0,RENDER_FUNCTION:1,WATCH_GETTER:2,WATCH_CALLBACK:3,WATCH_CLEANUP:4,NATIVE_EVENT_HANDLER:5,COMPONENT_EVENT_HANDLER:6,VNODE_HOOK:7};function f(n){n.shapeFlag&=~N.COMPONENT_SHOULD_KEEP_ALIVE,n.shapeFlag&=~N.COMPONENT_KEPT_ALIVE}function P(n){return n.shapeFlag&N.SUSPENSE?n.ssContent:n}const T=[],w=n=>s.defineComponent({name:u.componentName,__isKeepAlive:!0,setup(e,{slots:c}){const o=s.getCurrentInstance(),E=o.ctx,d=o.suspense,{renderer:{p,m:C,um:q,o:{createElement:W}}}=E,B=W("div");E.activate=(t,a,i,L,_)=>{const l=t.component;C(t,a,i,V.ENTER,d),p(l.vnode,t,a,i,l,d,L,t.slotScopeIds,_),s.queuePostFlushCb(()=>{l.isDeactivated=!1,l.a&&y(l.a);const R=t.props&&t.props.onVnodeMounted;R&&A(R,l.parent,t)},d)},E.deactivate=t=>{const a=t.component;C(t,B,null,V.LEAVE,d),s.queuePostFlushCb(()=>{a.da&&y(a.da);const i=t.props&&t.props.onVnodeUnmounted;i&&A(i,a.parent,t),a.isDeactivated=!0},d)};function j(t){f(t),q(t,o,d,!0)}let b=null,k=!1;const I=()=>{b&&(k?T[T.length-1].vnode=P(o.subTree):(console.log("cacheSubtree and push"),T.push({vnode:P(o.subTree)}),console.log(T)))};return s.onMounted(I),s.onUpdated(I),s.onBeforeUnmount(()=>{for(const t of T)j(t.vnode)}),()=>{if(k=!1,!c.default)return null;const t=c.default(),a=t[0];if(t.length>1)return t;if(!s.isVNode(a)||!(a.shapeFlag&N.STATEFUL_COMPONENT)&&!(a.shapeFlag&N.SUSPENSE))return a;let i=P(a);console.log("vnode.key",i.key);const L=H();if(i.el&&(i=s.cloneVNode(i),a.shapeFlag&N.SUSPENSE&&(a.ssContent=i)),b=L,m.action===u.backName){console.log("back");let _=T.pop();const l=T[T.length-1].vnode;i.el=l.el,i.component=l.component,i.transition&&s.setTransitionHooks(i,i.transition),i.shapeFlag|=N.COMPONENT_KEPT_ALIVE,f(_.vnode),_=null,k=!0}return i.shapeFlag|=N.COMPONENT_SHOULD_KEEP_ALIVE,S(a.type)?a:i}}}),K=n=>{const e=n.push.bind(n),c=n.go.bind(n),o=n.replace.bind(n),E=n.back.bind(n),d=n.forward.bind(n);n.push=p=>(m.action=u.pushName,e(p)),n.go=p=>{m.action=u.goName,c(p)},n.replace=p=>(m.action=u.replaceName,o(p)),n.back=()=>{m.action=u.backName,E()},n.forward=()=>{m.action=u.forwardName,d()}},x={install(n,{router:e,backCallback:c,forwardCallback:o}={router:null,backCallback:null,forwardCallback:null}){if(!e)throw Error("router is required");let E=null;e.options.history.listen((d,p,C)=>{E=C}),e.beforeEach(()=>{E&&(E.direction==="back"&&c?c():E.direction==="forward"&&o&&o(),E=null)})}},v=()=>{m.action=u.backName};return{install(n,{router:e,name:c=u.componentName,keyName:o=u.keyName}){if(!e)throw Error(`
 vue-router is necessary. 

`);n.component(c,w()),n.use(x,{router:e,backCallback:v}),K(e)}}});
