"use strict";const N=require("vue"),S=require("vue-router"),f={componentName:"VuePageStack",keyName:"stack-key",pushName:"push",goName:"go",replaceName:"replace",backName:"back",forwardName:"forward"};var l;(function(e){e[e.ELEMENT=1]="ELEMENT",e[e.FUNCTIONAL_COMPONENT=2]="FUNCTIONAL_COMPONENT",e[e.STATEFUL_COMPONENT=4]="STATEFUL_COMPONENT",e[e.TEXT_CHILDREN=8]="TEXT_CHILDREN",e[e.ARRAY_CHILDREN=16]="ARRAY_CHILDREN",e[e.SLOTS_CHILDREN=32]="SLOTS_CHILDREN",e[e.TELEPORT=64]="TELEPORT",e[e.SUSPENSE=128]="SUSPENSE",e[e.COMPONENT_SHOULD_KEEP_ALIVE=256]="COMPONENT_SHOULD_KEEP_ALIVE",e[e.COMPONENT_KEPT_ALIVE=512]="COMPONENT_KEPT_ALIVE",e[e.COMPONENT=6]="COMPONENT"})(l||(l={}));const V=(e,o)=>{for(let c=0;c<e.length;c++)e[c](o)};function R(e,o,c,t){N.callWithAsyncErrorHandling(e,o,D.VNODE_HOOK,[c,t])}const y=e=>e.__isSuspense,g={ENTER:0,LEAVE:1,REORDER:2},D={SETUP_FUNCTION:0,RENDER_FUNCTION:1,WATCH_GETTER:2,WATCH_CALLBACK:3,WATCH_CLEANUP:4,NATIVE_EVENT_HANDLER:5,COMPONENT_EVENT_HANDLER:6,VNODE_HOOK:7};function K(e){e.shapeFlag&=~l.COMPONENT_SHOULD_KEEP_ALIVE,e.shapeFlag&=~l.COMPONENT_KEPT_ALIVE}function L(e){return e.shapeFlag&l.SUSPENSE?e.ssContent:e}const a=[],H=e=>{for(let o=0;o<a.length;o++)if(a[o].key===e)return o;return-1},k=e=>N.defineComponent({name:f.componentName,__isKeepAlive:!0,setup(o,{slots:c}){console.log("VuePageStack setup",e);const t=N.getCurrentInstance(),r=t.ctx,O=t.suspense,{renderer:{p,m,um:M,o:{createElement:h}}}=r,U=h("div");r.activate=(n,i,T,E,s)=>{const u=n.component;m(n,i,T,g.ENTER,O),p(u.vnode,n,i,T,u,O,E,n.slotScopeIds,s),N.queuePostFlushCb(()=>{u.isDeactivated=!1,u.a&&V(u.a);const C=n.props&&n.props.onVnodeMounted;C&&R(C,u.parent,n)},O)},r.deactivate=n=>{const i=n.component;m(n,U,null,g.LEAVE,O),N.queuePostFlushCb(()=>{i.da&&V(i.da);const T=n.props&&n.props.onVnodeUnmounted;T&&R(T,i.parent,n),i.isDeactivated=!0},O)};function x(n){K(n),M(n,t,O,!0)}let _=null,P=!1;const A=()=>{console.log("cacheSubtree"),_!=null&&(P?a[a.length-1].vnode=L(t.subTree):a.push({key:_,vnode:L(t.subTree)})),console.log(_,a)};return N.onMounted(A),N.onUpdated(A),N.onBeforeUnmount(()=>{for(const n of a)x(n.vnode)}),()=>{console.log("return"),_=null,P=!1;const n=S.useRoute();console.log("route",n);const i=n.query[e];if(!c.default)return null;console.log(180);const T=c.default(),E=T[0];if(T.length>1)return T;if(!N.isVNode(E)||!(E.shapeFlag&l.STATEFUL_COMPONENT)&&!(E.shapeFlag&l.SUSPENSE))return E;console.log(191);let s=L(E);s.el&&(s=N.cloneVNode(s),E.shapeFlag&l.SUSPENSE&&(E.ssContent=s)),_=i,console.log("pendingCacheKey",_);let u=H(i);if(u!==-1){const C=a[u].vnode;s.el=C.el,s.component=C.component,s.transition&&N.setTransitionHooks(s,s.transition),s.shapeFlag|=l.COMPONENT_KEPT_ALIVE;for(let d=u+1;d<a.length;d++)a[d]=null;a.splice(u+1),P=!0}return s.shapeFlag|=l.COMPONENT_SHOULD_KEEP_ALIVE,y(E.type)?E:s}}});function I(e,o){return!!e[o]}function b(e){return e.replace(/[xy]/g,o=>{const c=Math.random()*16|0;return(o==="x"?c:c&3|8).toString(16)})}const q={install(e,{router:o,name:c=f.componentName,keyName:t=f.keyName}){if(!o)throw Error(`
 vue-router is necessary. 

`);e.component(c,k(t)),o.beforeEach((r,O)=>{if(console.log("beforeEach"),I(r.query,t))H(r.query[t])===-1?(r.params[t+"-dir"]=f.forwardName,console.log("前进")):(r.params[t+"-dir"]=f.backName,console.log("后退"));else{r.query[t]=b("xxxxxxxx");const p=!I(O.query,t);return{hash:r.hash,path:r.path,name:r.name,params:r.params,query:r.query,meta:r.meta,replace:p}}})}};module.exports=q;
//# sourceMappingURL=vue-page-stack.cjs.js.map
