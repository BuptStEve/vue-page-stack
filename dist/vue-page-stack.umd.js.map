{"version":3,"file":"vue-page-stack.umd.js","sources":["../lib/config/config.js","../lib/components/VuePageStack.js","../lib/main.js"],"sourcesContent":["export default {\n  componentName: 'VuePageStack',\n  keyName: 'stack-key',\n  pushName: 'push',\n  goName: 'go',\n  replaceName: 'replace',\n  backName: 'back',\n  forwardName: 'forward'\n};\n","import config from '../config/config';\n\nimport {\n  callWithAsyncErrorHandling,\n  defineComponent,\n  getCurrentInstance,\n  onBeforeUnmount,\n  onMounted,\n  onUpdated,\n  cloneVNode,\n  isVNode,\n  queuePostFlushCb,\n  setTransitionHooks\n} from 'vue';\n\nimport { useRoute } from 'vue-router';\n\nconsole.log(useRoute);\n\nvar ShapeFlags;\n(function (ShapeFlags) {\n  ShapeFlags[(ShapeFlags['ELEMENT'] = 1)] = 'ELEMENT';\n  ShapeFlags[(ShapeFlags['FUNCTIONAL_COMPONENT'] = 2)] = 'FUNCTIONAL_COMPONENT';\n  ShapeFlags[(ShapeFlags['STATEFUL_COMPONENT'] = 4)] = 'STATEFUL_COMPONENT';\n  ShapeFlags[(ShapeFlags['TEXT_CHILDREN'] = 8)] = 'TEXT_CHILDREN';\n  ShapeFlags[(ShapeFlags['ARRAY_CHILDREN'] = 16)] = 'ARRAY_CHILDREN';\n  ShapeFlags[(ShapeFlags['SLOTS_CHILDREN'] = 32)] = 'SLOTS_CHILDREN';\n  ShapeFlags[(ShapeFlags['TELEPORT'] = 64)] = 'TELEPORT';\n  ShapeFlags[(ShapeFlags['SUSPENSE'] = 128)] = 'SUSPENSE';\n  ShapeFlags[(ShapeFlags['COMPONENT_SHOULD_KEEP_ALIVE'] = 256)] = 'COMPONENT_SHOULD_KEEP_ALIVE';\n  ShapeFlags[(ShapeFlags['COMPONENT_KEPT_ALIVE'] = 512)] = 'COMPONENT_KEPT_ALIVE';\n  ShapeFlags[(ShapeFlags['COMPONENT'] = 6)] = 'COMPONENT';\n})(ShapeFlags || (ShapeFlags = {}));\n\nexport const invokeArrayFns = (fns, arg) => {\n  for (let i = 0; i < fns.length; i++) {\n    fns[i](arg);\n  }\n};\n\nfunction invokeVNodeHook(hook, instance, vnode, prevVNode) {\n  callWithAsyncErrorHandling(hook, instance, ErrorCodes.VNODE_HOOK, [vnode, prevVNode]);\n}\n\nconst isSuspense = type => type.__isSuspense;\n\nexport const MoveType = {\n  ENTER: 0,\n  LEAVE: 1,\n  REORDER: 2\n};\n\nexport const ErrorCodes = {\n  SETUP_FUNCTION: 0,\n  RENDER_FUNCTION: 1,\n  WATCH_GETTER: 2,\n  WATCH_CALLBACK: 3,\n  WATCH_CLEANUP: 4,\n  NATIVE_EVENT_HANDLER: 5,\n  COMPONENT_EVENT_HANDLER: 6,\n  VNODE_HOOK: 7\n};\n\nfunction resetShapeFlag(vnode) {\n  // bitwise operations to remove keep alive flags\n  vnode.shapeFlag &= ~ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE;\n  vnode.shapeFlag &= ~ShapeFlags.COMPONENT_KEPT_ALIVE;\n}\n\nfunction getInnerChild(vnode) {\n  return vnode.shapeFlag & ShapeFlags.SUSPENSE ? vnode.ssContent : vnode;\n}\n\nconst stack = [];\n\nconst getIndexByKey = key => {\n  for (let index = 0; index < stack.length; index++) {\n    if (stack[index].key === key) {\n      return index;\n    }\n  }\n  return -1;\n};\n\nconst VuePageStack = keyName => {\n  return defineComponent({\n    name: config.componentName,\n    __isKeepAlive: true,\n    setup(props, { slots }) {\n      console.log('VuePageStack setup', keyName);\n      const instance = getCurrentInstance();\n      const sharedContext = instance.ctx;\n\n      const parentSuspense = instance.suspense;\n\n      const {\n        renderer: {\n          p: patch,\n          m: move,\n          um: _unmount,\n          o: { createElement }\n        }\n      } = sharedContext;\n      const storageContainer = createElement('div');\n\n      sharedContext.activate = (vnode, container, anchor, isSVG, optimized) => {\n        const instance = vnode.component;\n        move(vnode, container, anchor, MoveType.ENTER, parentSuspense);\n        // in case props have changed\n        patch(instance.vnode, vnode, container, anchor, instance, parentSuspense, isSVG, vnode.slotScopeIds, optimized);\n        queuePostFlushCb(() => {\n          instance.isDeactivated = false;\n          if (instance.a) {\n            invokeArrayFns(instance.a);\n          }\n          const vnodeHook = vnode.props && vnode.props.onVnodeMounted;\n          if (vnodeHook) {\n            invokeVNodeHook(vnodeHook, instance.parent, vnode);\n          }\n        }, parentSuspense);\n      };\n\n      sharedContext.deactivate = vnode => {\n        const instance = vnode.component;\n        move(vnode, storageContainer, null, MoveType.LEAVE, parentSuspense);\n        queuePostFlushCb(() => {\n          if (instance.da) {\n            invokeArrayFns(instance.da);\n          }\n          const vnodeHook = vnode.props && vnode.props.onVnodeUnmounted;\n          if (vnodeHook) {\n            invokeVNodeHook(vnodeHook, instance.parent, vnode);\n          }\n          instance.isDeactivated = true;\n        }, parentSuspense);\n      };\n\n      function unmount(vnode) {\n        // reset the shapeFlag so it can be properly unmounted\n        resetShapeFlag(vnode);\n        _unmount(vnode, instance, parentSuspense, true);\n      }\n\n      // cache sub tree after render\n      let pendingCacheKey = null;\n      let useCache = false;\n\n      const cacheSubtree = () => {\n        // fix #1621, the pendingCacheKey could be 0\n        console.log('cacheSubtree');\n        if (pendingCacheKey != null) {\n          if (useCache) {\n            stack[stack.length - 1].vnode = getInnerChild(instance.subTree);\n          } else {\n            stack.push({ key: pendingCacheKey, vnode: getInnerChild(instance.subTree) });\n          }\n        }\n        console.log(pendingCacheKey, stack);\n      };\n      onMounted(cacheSubtree);\n      onUpdated(cacheSubtree);\n\n      // clear all cache\n      onBeforeUnmount(() => {\n        for (const cachedStack of stack) {\n          unmount(cachedStack.vnode);\n        }\n      });\n\n      return () => {\n        console.log('return');\n        pendingCacheKey = null;\n        useCache = false;\n        // 这里可以访问到route\n        const route = useRoute();\n        console.log(route);\n\n        // 路由上的Key\n        const key = route.query[keyName];\n\n        if (!slots.default) {\n          return null;\n        }\n\n        console.log(180);\n\n        const children = slots.default();\n        const rawVNode = children[0];\n        if (children.length > 1) {\n          return children;\n        } else if (\n          !isVNode(rawVNode) ||\n          (!(rawVNode.shapeFlag & ShapeFlags.STATEFUL_COMPONENT) && !(rawVNode.shapeFlag & ShapeFlags.SUSPENSE))\n        ) {\n          return rawVNode;\n        }\n\n        console.log(191);\n\n        let vnode = getInnerChild(rawVNode);\n\n        // clone vnode if it's reused because we are going to mutate it\n        if (vnode.el) {\n          vnode = cloneVNode(vnode);\n          if (rawVNode.shapeFlag & ShapeFlags.SUSPENSE) {\n            rawVNode.ssContent = vnode;\n          }\n        }\n\n        pendingCacheKey = key;\n\n        console.log('pendingCacheKey', pendingCacheKey);\n\n        let index = getIndexByKey(key);\n        if (index !== -1) {\n          // vnode.componentInstance = stack[index].vnode.componentInstance;\n          const cachedVNode = stack[index].vnode;\n\n          vnode.el = cachedVNode.el;\n          vnode.component = cachedVNode.component;\n          if (vnode.transition) {\n            // recursively update transition hooks on subTree\n            setTransitionHooks(vnode, vnode.transition);\n          }\n          // avoid vnode being mounted as fresh\n          vnode.shapeFlag |= ShapeFlags.COMPONENT_KEPT_ALIVE;\n\n          // destroy the instances that will be spliced\n          for (let i = index + 1; i < stack.length; i++) {\n            stack[i] = null;\n          }\n          stack.splice(index + 1);\n          useCache = true;\n        }\n\n        // avoid vnode being unmounted\n        vnode.shapeFlag |= ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE;\n\n        return isSuspense(rawVNode.type) ? rawVNode : vnode;\n      };\n    }\n  });\n};\n\nfunction getStack() {\n  return stack;\n}\n\nexport { VuePageStack, getIndexByKey, getStack };\n","import { VuePageStack, getIndexByKey } from './components/VuePageStack.js';\n// import { VuePageStack, getIndexByKey } from './components/KeepPageStack.js';\n// import { VuePageStack, getIndexByKey } from './components/KeepPageStack3.3.2.js';\n// import mixin from './mixin';\nimport history from './history';\nimport config from './config/config';\n\nfunction hasKey(query, keyName) {\n  return !!query[keyName];\n}\n\nfunction getKey(str) {\n  return str.replace(/[xy]/g, c => {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nconst VuePageStackPlugin = {\n  install(app, { router, name = config.componentName, keyName = config.keyName }) {\n    if (!router) {\n      throw Error('\\n vue-router is necessary. \\n\\n');\n    }\n    app.component(name, VuePageStack(keyName));\n\n    router.beforeEach((to, from) => {\n      console.log('beforeEach');\n      if (!hasKey(to.query, keyName)) {\n        to.query[keyName] = getKey('xxxxxxxx');\n        const replace = history.action === config.replaceName || !hasKey(from.query, keyName);\n        return {\n          hash: to.hash,\n          path: to.path,\n          name: to.name,\n          params: to.params,\n          query: to.query,\n          meta: to.meta,\n          replace\n        };\n      } else {\n        const index = getIndexByKey(to.query[keyName]);\n        if (index === -1) {\n          to.params[keyName + '-dir'] = config.forwardName;\n          console.log('前进');\n        } else {\n          to.params[keyName + '-dir'] = config.backName;\n          console.log('后退');\n        }\n      }\n    });\n  }\n};\n\nexport default VuePageStackPlugin;\n"],"names":["useRoute","ShapeFlags","callWithAsyncErrorHandling","defineComponent","getCurrentInstance","instance","queuePostFlushCb","onMounted","onUpdated","onBeforeUnmount","isVNode","cloneVNode","setTransitionHooks"],"mappings":"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"}