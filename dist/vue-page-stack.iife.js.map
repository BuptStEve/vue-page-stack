{"version":3,"file":"vue-page-stack.iife.js","sources":["../lib/config/config.js","../lib/components/VuePageStack.js","../lib/history.Js","../lib/eventRegister.js","../lib/main.js"],"sourcesContent":["export default {\n  componentName: 'VuePageStack',\n  keyName: 'stack-key',\n  pushName: 'push',\n  goName: 'go',\n  replaceName: 'replace',\n  backName: 'back',\n  forwardName: 'forward'\n};\n","import config from '../config/config';\n\nimport {\n  callWithAsyncErrorHandling,\n  defineComponent,\n  getCurrentInstance,\n  onBeforeUnmount,\n  onMounted,\n  onUpdated,\n  cloneVNode,\n  isVNode,\n  queuePostFlushCb,\n  setTransitionHooks\n} from 'vue';\n\nimport { useRoute } from 'vue-router';\n\nvar ShapeFlags;\n(function (ShapeFlags) {\n  ShapeFlags[(ShapeFlags['ELEMENT'] = 1)] = 'ELEMENT';\n  ShapeFlags[(ShapeFlags['FUNCTIONAL_COMPONENT'] = 2)] = 'FUNCTIONAL_COMPONENT';\n  ShapeFlags[(ShapeFlags['STATEFUL_COMPONENT'] = 4)] = 'STATEFUL_COMPONENT';\n  ShapeFlags[(ShapeFlags['TEXT_CHILDREN'] = 8)] = 'TEXT_CHILDREN';\n  ShapeFlags[(ShapeFlags['ARRAY_CHILDREN'] = 16)] = 'ARRAY_CHILDREN';\n  ShapeFlags[(ShapeFlags['SLOTS_CHILDREN'] = 32)] = 'SLOTS_CHILDREN';\n  ShapeFlags[(ShapeFlags['TELEPORT'] = 64)] = 'TELEPORT';\n  ShapeFlags[(ShapeFlags['SUSPENSE'] = 128)] = 'SUSPENSE';\n  ShapeFlags[(ShapeFlags['COMPONENT_SHOULD_KEEP_ALIVE'] = 256)] = 'COMPONENT_SHOULD_KEEP_ALIVE';\n  ShapeFlags[(ShapeFlags['COMPONENT_KEPT_ALIVE'] = 512)] = 'COMPONENT_KEPT_ALIVE';\n  ShapeFlags[(ShapeFlags['COMPONENT'] = 6)] = 'COMPONENT';\n})(ShapeFlags || (ShapeFlags = {}));\n\nexport const invokeArrayFns = (fns, arg) => {\n  for (let i = 0; i < fns.length; i++) {\n    fns[i](arg);\n  }\n};\n\nfunction invokeVNodeHook(hook, instance, vnode, prevVNode) {\n  callWithAsyncErrorHandling(hook, instance, ErrorCodes.VNODE_HOOK, [vnode, prevVNode]);\n}\n\nconst isSuspense = type => type.__isSuspense;\n\nexport const MoveType = {\n  ENTER: 0,\n  LEAVE: 1,\n  REORDER: 2\n};\n\nexport const ErrorCodes = {\n  SETUP_FUNCTION: 0,\n  RENDER_FUNCTION: 1,\n  WATCH_GETTER: 2,\n  WATCH_CALLBACK: 3,\n  WATCH_CLEANUP: 4,\n  NATIVE_EVENT_HANDLER: 5,\n  COMPONENT_EVENT_HANDLER: 6,\n  VNODE_HOOK: 7\n};\n\nfunction resetShapeFlag(vnode) {\n  // bitwise operations to remove keep alive flags\n  vnode.shapeFlag &= ~ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE;\n  vnode.shapeFlag &= ~ShapeFlags.COMPONENT_KEPT_ALIVE;\n}\n\nfunction getInnerChild(vnode) {\n  return vnode.shapeFlag & ShapeFlags.SUSPENSE ? vnode.ssContent : vnode;\n}\n\nconst stack = [];\n\nconst getIndexByKey = key => {\n  for (let index = 0; index < stack.length; index++) {\n    if (stack[index].key === key) {\n      return index;\n    }\n  }\n  return -1;\n};\n\nconst VuePageStack = keyName => {\n  return defineComponent({\n    name: config.componentName,\n    __isKeepAlive: true,\n    setup(props, { slots }) {\n      const instance = getCurrentInstance();\n      const sharedContext = instance.ctx;\n\n      const parentSuspense = instance.suspense;\n\n      const {\n        renderer: {\n          p: patch,\n          m: move,\n          um: _unmount,\n          o: { createElement }\n        }\n      } = sharedContext;\n      const storageContainer = createElement('div');\n\n      sharedContext.activate = (vnode, container, anchor, isSVG, optimized) => {\n        const instance = vnode.component;\n        move(vnode, container, anchor, MoveType.ENTER, parentSuspense);\n        // in case props have changed\n        patch(instance.vnode, vnode, container, anchor, instance, parentSuspense, isSVG, vnode.slotScopeIds, optimized);\n        queuePostFlushCb(() => {\n          instance.isDeactivated = false;\n          if (instance.a) {\n            invokeArrayFns(instance.a);\n          }\n          const vnodeHook = vnode.props && vnode.props.onVnodeMounted;\n          if (vnodeHook) {\n            invokeVNodeHook(vnodeHook, instance.parent, vnode);\n          }\n        }, parentSuspense);\n      };\n\n      sharedContext.deactivate = vnode => {\n        const instance = vnode.component;\n        move(vnode, storageContainer, null, MoveType.LEAVE, parentSuspense);\n        queuePostFlushCb(() => {\n          if (instance.da) {\n            invokeArrayFns(instance.da);\n          }\n          const vnodeHook = vnode.props && vnode.props.onVnodeUnmounted;\n          if (vnodeHook) {\n            invokeVNodeHook(vnodeHook, instance.parent, vnode);\n          }\n          instance.isDeactivated = true;\n        }, parentSuspense);\n      };\n\n      function unmount(vnode) {\n        // reset the shapeFlag so it can be properly unmounted\n        resetShapeFlag(vnode);\n        _unmount(vnode, instance, parentSuspense, true);\n      }\n\n      // cache sub tree after render\n      let pendingCacheKey = null;\n      let useCache = false;\n\n      const cacheSubtree = () => {\n        // fix #1621, the pendingCacheKey could be 0\n        if (pendingCacheKey != null) {\n          if (useCache) {\n            stack[stack.length - 1].vnode = getInnerChild(instance.subTree);\n          } else {\n            stack.push({ key: pendingCacheKey, vnode: getInnerChild(instance.subTree) });\n          }\n        }\n      };\n      onMounted(cacheSubtree);\n      onUpdated(cacheSubtree);\n\n      // clear all cache\n      onBeforeUnmount(() => {\n        for (const cachedStack of stack) {\n          unmount(cachedStack.vnode);\n        }\n      });\n\n      return () => {\n        pendingCacheKey = null;\n        useCache = false;\n        // 这里可以访问到route\n        const route = useRoute();\n\n        // 路由上的Key\n        const key = route.query[keyName];\n\n        if (!slots.default) {\n          return null;\n        }\n\n        const children = slots.default();\n        const rawVNode = children[0];\n        if (children.length > 1) {\n          return children;\n        } else if (\n          !isVNode(rawVNode) ||\n          (!(rawVNode.shapeFlag & ShapeFlags.STATEFUL_COMPONENT) && !(rawVNode.shapeFlag & ShapeFlags.SUSPENSE))\n        ) {\n          return rawVNode;\n        }\n\n        let vnode = getInnerChild(rawVNode);\n\n        // clone vnode if it's reused because we are going to mutate it\n        if (vnode.el) {\n          vnode = cloneVNode(vnode);\n          if (rawVNode.shapeFlag & ShapeFlags.SUSPENSE) {\n            rawVNode.ssContent = vnode;\n          }\n        }\n\n        pendingCacheKey = key;\n\n        let index = getIndexByKey(key);\n        if (index !== -1) {\n          // vnode.componentInstance = stack[index].vnode.componentInstance;\n          const cachedVNode = stack[index].vnode;\n\n          vnode.el = cachedVNode.el;\n          vnode.component = cachedVNode.component;\n          if (vnode.transition) {\n            // recursively update transition hooks on subTree\n            setTransitionHooks(vnode, vnode.transition);\n          }\n          // avoid vnode being mounted as fresh\n          vnode.shapeFlag |= ShapeFlags.COMPONENT_KEPT_ALIVE;\n\n          // destroy the instances that will be spliced\n          for (let i = index + 1; i < stack.length; i++) {\n            resetShapeFlag(stack[i].vnode);\n            stack[i] = null;\n          }\n          stack.splice(index + 1);\n          useCache = true;\n        }\n\n        // avoid vnode being unmounted\n        vnode.shapeFlag |= ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE;\n\n        return isSuspense(rawVNode.type) ? rawVNode : vnode;\n      };\n    }\n  });\n};\n\nfunction getStack() {\n  return stack;\n}\n\nexport { VuePageStack, getIndexByKey, getStack };\n","import config from './config/config';\n\nconst histoty = {\n  action: config.pushName\n};\n\nexport default histoty;\n","import history from './history';\nimport config from './config/config';\n\nconst eventRegister = router => {\n  const routerPush = router.push.bind(router);\n  const routerGo = router.go.bind(router);\n  const routerReplace = router.replace.bind(router);\n  const routerBack = router.back.bind(router);\n  const routerForward = router.forward.bind(router);\n\n  router.push = to => {\n    history.action = config.pushName;\n    return routerPush(to);\n  };\n\n  router.go = n => {\n    history.action = config.goName;\n    routerGo(n);\n  };\n\n  router.replace = to => {\n    history.action = config.replaceName;\n    return routerReplace(to);\n  };\n\n  router.back = () => {\n    history.action = config.backName;\n    routerBack();\n  };\n\n  router.forward = () => {\n    history.action = config.forwardName;\n    routerForward();\n  };\n};\n\nexport default eventRegister;\n","import { VuePageStack, getIndexByKey } from './components/VuePageStack.js';\nimport eventRegister from './eventRegister';\nimport history from './history';\nimport config from './config/config';\n\nfunction hasKey(query, keyName) {\n  return !!query[keyName];\n}\n\nfunction getKey(str) {\n  return str.replace(/[xy]/g, c => {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nconst VuePageStackPlugin = {\n  install(app, { router, name = config.componentName, keyName = config.keyName }) {\n    if (!router) {\n      throw Error('\\n vue-router is necessary. \\n\\n');\n    }\n    app.component(name, VuePageStack(keyName));\n\n    eventRegister(router);\n\n    router.beforeEach((to, from) => {\n      if (!hasKey(to.query, keyName)) {\n        to.query[keyName] = getKey('xxxxxxxx');\n        // !hasKey() 为了适配初始化路由\n        const replace = history.action === config.replaceName || !hasKey(from.query, keyName);\n        return {\n          hash: to.hash,\n          path: to.path,\n          name: to.name,\n          params: to.params,\n          query: to.query,\n          meta: to.meta,\n          replace\n        };\n      } else {\n        const index = getIndexByKey(to.query[keyName]);\n        if (index === -1) {\n          to.params[keyName + '-dir'] = config.forwardName;\n        } else {\n          to.params[keyName + '-dir'] = config.backName;\n        }\n      }\n    });\n  }\n};\n\nexport default VuePageStackPlugin;\n"],"names":["config","ShapeFlags","invokeArrayFns","fns","arg","i","invokeVNodeHook","hook","instance","vnode","prevVNode","callWithAsyncErrorHandling","ErrorCodes","isSuspense","type","MoveType","resetShapeFlag","getInnerChild","stack","getIndexByKey","key","index","VuePageStack","keyName","defineComponent","props","slots","getCurrentInstance","sharedContext","parentSuspense","patch","move","_unmount","createElement","storageContainer","container","anchor","isSVG","optimized","queuePostFlushCb","vnodeHook","unmount","pendingCacheKey","useCache","cacheSubtree","onMounted","onUpdated","onBeforeUnmount","cachedStack","useRoute","children","rawVNode","isVNode","cloneVNode","cachedVNode","setTransitionHooks","histoty","eventRegister","router","routerPush","routerGo","routerReplace","routerBack","routerForward","to","history","n","hasKey","query","getKey","str","c","app","name","from","replace"],"mappings":"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"}