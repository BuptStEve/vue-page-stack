(function(t,d){typeof exports=="object"&&typeof module<"u"?module.exports=d(require("vue"),require("vue-router")):typeof define=="function"&&define.amd?define(["vue","vue-router"],d):(t=typeof globalThis<"u"?globalThis:t||self,t.VuePageStack=d(t.Vue,t.vueRouter))})(this,function(t,d){"use strict";const _={componentName:"VuePageStack",keyName:"stack-key",pushName:"push",goName:"go",replaceName:"replace",backName:"back",forwardName:"forward"};var a;(function(e){e[e.ELEMENT=1]="ELEMENT",e[e.FUNCTIONAL_COMPONENT=2]="FUNCTIONAL_COMPONENT",e[e.STATEFUL_COMPONENT=4]="STATEFUL_COMPONENT",e[e.TEXT_CHILDREN=8]="TEXT_CHILDREN",e[e.ARRAY_CHILDREN=16]="ARRAY_CHILDREN",e[e.SLOTS_CHILDREN=32]="SLOTS_CHILDREN",e[e.TELEPORT=64]="TELEPORT",e[e.SUSPENSE=128]="SUSPENSE",e[e.COMPONENT_SHOULD_KEEP_ALIVE=256]="COMPONENT_SHOULD_KEEP_ALIVE",e[e.COMPONENT_KEPT_ALIVE=512]="COMPONENT_KEPT_ALIVE",e[e.COMPONENT=6]="COMPONENT"})(a||(a={}));const A=(e,o)=>{for(let E=0;E<e.length;E++)e[E](o)};function V(e,o,E,r){t.callWithAsyncErrorHandling(e,o,S.VNODE_HOOK,[E,r])}const M=e=>e.__isSuspense,h={ENTER:0,LEAVE:1,REORDER:2},S={SETUP_FUNCTION:0,RENDER_FUNCTION:1,WATCH_GETTER:2,WATCH_CALLBACK:3,WATCH_CLEANUP:4,NATIVE_EVENT_HANDLER:5,COMPONENT_EVENT_HANDLER:6,VNODE_HOOK:7};function x(e){e.shapeFlag&=~a.COMPONENT_SHOULD_KEEP_ALIVE,e.shapeFlag&=~a.COMPONENT_KEPT_ALIVE}function P(e){return e.shapeFlag&a.SUSPENSE?e.ssContent:e}const u=[],R=e=>{for(let o=0;o<u.length;o++)if(u[o].key===e)return o;return-1},y=e=>t.defineComponent({name:_.componentName,__isKeepAlive:!0,setup(o,{slots:E}){console.log("VuePageStack setup");const r=t.getCurrentInstance(),s=r.ctx,f=r.suspense,{renderer:{p:C,m:I,um:k,o:{createElement:D}}}=s,K=D("div");s.activate=(n,l,T,i,c)=>{const N=n.component;I(n,l,T,h.ENTER,f),C(N.vnode,n,l,T,N,f,i,n.slotScopeIds,c),t.queuePostFlushCb(()=>{N.isDeactivated=!1,N.a&&A(N.a);const p=n.props&&n.props.onVnodeMounted;p&&V(p,N.parent,n)},f)},s.deactivate=n=>{const l=n.component;I(n,K,null,h.LEAVE,f),t.queuePostFlushCb(()=>{l.da&&A(l.da);const T=n.props&&n.props.onVnodeUnmounted;T&&V(T,l.parent,n),l.isDeactivated=!0},f)};function q(n){x(n),k(n,r,f,!0)}let O=null,m=!1;const H=()=>{console.log("cacheSubtree"),O!=null&&(m?u[u.length-1].vnode=P(r.subTree):u.push({key:O,vnode:P(r.subTree)})),console.log(O,u)};return t.onMounted(H),t.onUpdated(H),t.onBeforeUnmount(()=>{for(const n of u)q(n.vnode)}),()=>{console.log("return"),O=null,m=!1;const l=d.useRoute().query[e];if(!E.default)return null;console.log(180);const T=E.default(),i=T[0];if(T.length>1)return T;if(!t.isVNode(i)||!(i.shapeFlag&a.STATEFUL_COMPONENT)&&!(i.shapeFlag&a.SUSPENSE))return i;console.log(191);let c=P(i);c.el&&(c=t.cloneVNode(c),i.shapeFlag&a.SUSPENSE&&(i.ssContent=c)),O=l,console.log("pendingCacheKey",O);let N=R(l);if(N!==-1){const p=u[N].vnode;c.el=p.el,c.component=p.component,c.transition&&t.setTransitionHooks(c,c.transition),c.shapeFlag|=a.COMPONENT_KEPT_ALIVE;for(let L=N+1;L<u.length;L++)u[L]=null;u.splice(N+1),m=!0}return c.shapeFlag|=a.COMPONENT_SHOULD_KEEP_ALIVE,M(i.type)?i:c}}});function g(e,o){return!!e[o]}function U(e){return e.replace(/[xy]/g,o=>{const E=Math.random()*16|0;return(o==="x"?E:E&3|8).toString(16)})}return{install(e,{router:o,name:E=_.componentName,keyName:r=_.keyName}){if(!o)throw Error(`
 vue-router is necessary. 

`);e.component(E,y(r)),o.beforeEach((s,f)=>{if(console.log("beforeEach"),g(s.query,r))R(s.query[r])===-1?(s.params[r+"-dir"]=_.forwardName,console.log("前进")):(s.params[r+"-dir"]=_.backName,console.log("后退"));else{s.query[r]=U("xxxxxxxx");const C=!g(f.query,r);return{hash:s.hash,path:s.path,name:s.name,params:s.params,query:s.query,meta:s.meta,replace:C}}})}}});
