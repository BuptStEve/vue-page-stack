{"version":3,"file":"vue-page-stack.mjs","sources":["../lib/config/config.js","../lib/components/VuePageStack.js","../lib/main.js"],"sourcesContent":["export default {\n  componentName: 'VuePageStack',\n  keyName: 'stack-key',\n  pushName: 'push',\n  goName: 'go',\n  replaceName: 'replace',\n  backName: 'back',\n  forwardName: 'forward'\n};\n","import config from '../config/config';\n\nimport {\n  callWithAsyncErrorHandling,\n  defineComponent,\n  getCurrentInstance,\n  onBeforeUnmount,\n  onMounted,\n  onUpdated,\n  cloneVNode,\n  isVNode,\n  queuePostFlushCb,\n  setTransitionHooks\n} from 'vue';\n\nimport { useRoute } from 'vue-router';\n\nvar ShapeFlags;\n(function (ShapeFlags) {\n  ShapeFlags[(ShapeFlags['ELEMENT'] = 1)] = 'ELEMENT';\n  ShapeFlags[(ShapeFlags['FUNCTIONAL_COMPONENT'] = 2)] = 'FUNCTIONAL_COMPONENT';\n  ShapeFlags[(ShapeFlags['STATEFUL_COMPONENT'] = 4)] = 'STATEFUL_COMPONENT';\n  ShapeFlags[(ShapeFlags['TEXT_CHILDREN'] = 8)] = 'TEXT_CHILDREN';\n  ShapeFlags[(ShapeFlags['ARRAY_CHILDREN'] = 16)] = 'ARRAY_CHILDREN';\n  ShapeFlags[(ShapeFlags['SLOTS_CHILDREN'] = 32)] = 'SLOTS_CHILDREN';\n  ShapeFlags[(ShapeFlags['TELEPORT'] = 64)] = 'TELEPORT';\n  ShapeFlags[(ShapeFlags['SUSPENSE'] = 128)] = 'SUSPENSE';\n  ShapeFlags[(ShapeFlags['COMPONENT_SHOULD_KEEP_ALIVE'] = 256)] = 'COMPONENT_SHOULD_KEEP_ALIVE';\n  ShapeFlags[(ShapeFlags['COMPONENT_KEPT_ALIVE'] = 512)] = 'COMPONENT_KEPT_ALIVE';\n  ShapeFlags[(ShapeFlags['COMPONENT'] = 6)] = 'COMPONENT';\n})(ShapeFlags || (ShapeFlags = {}));\n\nexport const invokeArrayFns = (fns, arg) => {\n  for (let i = 0; i < fns.length; i++) {\n    fns[i](arg);\n  }\n};\n\nfunction invokeVNodeHook(hook, instance, vnode, prevVNode) {\n  callWithAsyncErrorHandling(hook, instance, ErrorCodes.VNODE_HOOK, [vnode, prevVNode]);\n}\n\nconst isSuspense = type => type.__isSuspense;\n\nexport const MoveType = {\n  ENTER: 0,\n  LEAVE: 1,\n  REORDER: 2\n};\n\nexport const ErrorCodes = {\n  SETUP_FUNCTION: 0,\n  RENDER_FUNCTION: 1,\n  WATCH_GETTER: 2,\n  WATCH_CALLBACK: 3,\n  WATCH_CLEANUP: 4,\n  NATIVE_EVENT_HANDLER: 5,\n  COMPONENT_EVENT_HANDLER: 6,\n  VNODE_HOOK: 7\n};\n\nfunction resetShapeFlag(vnode) {\n  // bitwise operations to remove keep alive flags\n  vnode.shapeFlag &= ~ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE;\n  vnode.shapeFlag &= ~ShapeFlags.COMPONENT_KEPT_ALIVE;\n}\n\nfunction getInnerChild(vnode) {\n  return vnode.shapeFlag & ShapeFlags.SUSPENSE ? vnode.ssContent : vnode;\n}\n\nconst stack = [];\n\nconst getIndexByKey = key => {\n  for (let index = 0; index < stack.length; index++) {\n    if (stack[index].key === key) {\n      return index;\n    }\n  }\n  return -1;\n};\n\nconst VuePageStack = keyName => {\n  return defineComponent({\n    name: config.componentName,\n    __isKeepAlive: true,\n    setup(props, { slots }) {\n      console.log('VuePageStack setup');\n      const instance = getCurrentInstance();\n      const sharedContext = instance.ctx;\n\n      const parentSuspense = instance.suspense;\n\n      const {\n        renderer: {\n          p: patch,\n          m: move,\n          um: _unmount,\n          o: { createElement }\n        }\n      } = sharedContext;\n      const storageContainer = createElement('div');\n\n      sharedContext.activate = (vnode, container, anchor, isSVG, optimized) => {\n        const instance = vnode.component;\n        move(vnode, container, anchor, MoveType.ENTER, parentSuspense);\n        // in case props have changed\n        patch(instance.vnode, vnode, container, anchor, instance, parentSuspense, isSVG, vnode.slotScopeIds, optimized);\n        queuePostFlushCb(() => {\n          instance.isDeactivated = false;\n          if (instance.a) {\n            invokeArrayFns(instance.a);\n          }\n          const vnodeHook = vnode.props && vnode.props.onVnodeMounted;\n          if (vnodeHook) {\n            invokeVNodeHook(vnodeHook, instance.parent, vnode);\n          }\n        }, parentSuspense);\n      };\n\n      sharedContext.deactivate = vnode => {\n        const instance = vnode.component;\n        move(vnode, storageContainer, null, MoveType.LEAVE, parentSuspense);\n        queuePostFlushCb(() => {\n          if (instance.da) {\n            invokeArrayFns(instance.da);\n          }\n          const vnodeHook = vnode.props && vnode.props.onVnodeUnmounted;\n          if (vnodeHook) {\n            invokeVNodeHook(vnodeHook, instance.parent, vnode);\n          }\n          instance.isDeactivated = true;\n        }, parentSuspense);\n      };\n\n      function unmount(vnode) {\n        // reset the shapeFlag so it can be properly unmounted\n        resetShapeFlag(vnode);\n        _unmount(vnode, instance, parentSuspense, true);\n      }\n\n      // cache sub tree after render\n      let pendingCacheKey = null;\n      let useCache = false;\n\n      const cacheSubtree = () => {\n        // fix #1621, the pendingCacheKey could be 0\n        console.log('cacheSubtree');\n        if (pendingCacheKey != null) {\n          if (useCache) {\n            stack[stack.length - 1].vnode = getInnerChild(instance.subTree);\n          } else {\n            stack.push({ key: pendingCacheKey, vnode: getInnerChild(instance.subTree) });\n          }\n        }\n        console.log(pendingCacheKey, stack);\n      };\n      onMounted(cacheSubtree);\n      onUpdated(cacheSubtree);\n\n      // clear all cache\n      onBeforeUnmount(() => {\n        for (const cachedStack of stack) {\n          unmount(cachedStack.vnode);\n        }\n      });\n\n      return () => {\n        console.log('return');\n        pendingCacheKey = null;\n        useCache = false;\n        // 这里可以访问到route\n        const route = useRoute();\n        // 路由上的Key\n        const key = route.query[keyName];\n\n        if (!slots.default) {\n          return null;\n        }\n\n        console.log(180);\n\n        const children = slots.default();\n        const rawVNode = children[0];\n        if (children.length > 1) {\n          return children;\n        } else if (\n          !isVNode(rawVNode) ||\n          (!(rawVNode.shapeFlag & ShapeFlags.STATEFUL_COMPONENT) && !(rawVNode.shapeFlag & ShapeFlags.SUSPENSE))\n        ) {\n          return rawVNode;\n        }\n\n        console.log(191);\n\n        let vnode = getInnerChild(rawVNode);\n\n        // clone vnode if it's reused because we are going to mutate it\n        if (vnode.el) {\n          vnode = cloneVNode(vnode);\n          if (rawVNode.shapeFlag & ShapeFlags.SUSPENSE) {\n            rawVNode.ssContent = vnode;\n          }\n        }\n\n        pendingCacheKey = key;\n\n        console.log('pendingCacheKey', pendingCacheKey);\n\n        let index = getIndexByKey(key);\n        if (index !== -1) {\n          // vnode.componentInstance = stack[index].vnode.componentInstance;\n          const cachedVNode = stack[index].vnode;\n\n          vnode.el = cachedVNode.el;\n          vnode.component = cachedVNode.component;\n          if (vnode.transition) {\n            // recursively update transition hooks on subTree\n            setTransitionHooks(vnode, vnode.transition);\n          }\n          // avoid vnode being mounted as fresh\n          vnode.shapeFlag |= ShapeFlags.COMPONENT_KEPT_ALIVE;\n\n          // destroy the instances that will be spliced\n          for (let i = index + 1; i < stack.length; i++) {\n            stack[i] = null;\n          }\n          stack.splice(index + 1);\n          useCache = true;\n        }\n\n        // avoid vnode being unmounted\n        vnode.shapeFlag |= ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE;\n\n        return isSuspense(rawVNode.type) ? rawVNode : vnode;\n      };\n    }\n  });\n};\n\nfunction getStack() {\n  return stack;\n}\n\nexport { VuePageStack, getIndexByKey, getStack };\n","import { VuePageStack, getIndexByKey } from './components/VuePageStack.js';\n// import { VuePageStack, getIndexByKey } from './components/KeepPageStack.js';\n// import { VuePageStack, getIndexByKey } from './components/KeepPageStack3.3.2.js';\n// import mixin from './mixin';\nimport history from './history';\nimport config from './config/config';\n\nfunction hasKey(query, keyName) {\n  return !!query[keyName];\n}\n\nfunction getKey(str) {\n  return str.replace(/[xy]/g, c => {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nconst VuePageStackPlugin = {\n  install(app, { router, name = config.componentName, keyName = config.keyName }) {\n    if (!router) {\n      throw Error('\\n vue-router is necessary. \\n\\n');\n    }\n    app.component(name, VuePageStack(keyName));\n\n    router.beforeEach((to, from) => {\n      console.log('beforeEach');\n      if (!hasKey(to.query, keyName)) {\n        to.query[keyName] = getKey('xxxxxxxx');\n        const replace = history.action === config.replaceName || !hasKey(from.query, keyName);\n        return {\n          hash: to.hash,\n          path: to.path,\n          name: to.name,\n          params: to.params,\n          query: to.query,\n          meta: to.meta,\n          replace\n        };\n      } else {\n        const index = getIndexByKey(to.query[keyName]);\n        if (index === -1) {\n          to.params[keyName + '-dir'] = config.forwardName;\n          console.log('前进');\n        } else {\n          to.params[keyName + '-dir'] = config.backName;\n          console.log('后退');\n        }\n      }\n    });\n  }\n};\n\nexport default VuePageStackPlugin;\n"],"names":["ShapeFlags","instance"],"mappings":"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"}