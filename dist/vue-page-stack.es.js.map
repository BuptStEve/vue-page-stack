{"version":3,"file":"vue-page-stack.es.js","sources":["../lib/config/config.js","../lib/components/VuePageStack.js","../lib/main.js"],"sourcesContent":["export default {\n  componentName: 'VuePageStack',\n  keyName: 'stack-key',\n  pushName: 'push',\n  goName: 'go',\n  replaceName: 'replace',\n  backName: 'back',\n  forwardName: 'forward'\n};\n","import config from '../config/config';\n\nimport {\n  callWithAsyncErrorHandling,\n  defineComponent,\n  getCurrentInstance,\n  onBeforeUnmount,\n  onMounted,\n  onUpdated,\n  cloneVNode,\n  isVNode,\n  queuePostFlushCb,\n  setTransitionHooks\n} from 'vue';\n\nimport { useRoute } from 'vue-router';\n\nconsole.log(useRoute);\n\nvar ShapeFlags;\n(function (ShapeFlags) {\n  ShapeFlags[(ShapeFlags['ELEMENT'] = 1)] = 'ELEMENT';\n  ShapeFlags[(ShapeFlags['FUNCTIONAL_COMPONENT'] = 2)] = 'FUNCTIONAL_COMPONENT';\n  ShapeFlags[(ShapeFlags['STATEFUL_COMPONENT'] = 4)] = 'STATEFUL_COMPONENT';\n  ShapeFlags[(ShapeFlags['TEXT_CHILDREN'] = 8)] = 'TEXT_CHILDREN';\n  ShapeFlags[(ShapeFlags['ARRAY_CHILDREN'] = 16)] = 'ARRAY_CHILDREN';\n  ShapeFlags[(ShapeFlags['SLOTS_CHILDREN'] = 32)] = 'SLOTS_CHILDREN';\n  ShapeFlags[(ShapeFlags['TELEPORT'] = 64)] = 'TELEPORT';\n  ShapeFlags[(ShapeFlags['SUSPENSE'] = 128)] = 'SUSPENSE';\n  ShapeFlags[(ShapeFlags['COMPONENT_SHOULD_KEEP_ALIVE'] = 256)] = 'COMPONENT_SHOULD_KEEP_ALIVE';\n  ShapeFlags[(ShapeFlags['COMPONENT_KEPT_ALIVE'] = 512)] = 'COMPONENT_KEPT_ALIVE';\n  ShapeFlags[(ShapeFlags['COMPONENT'] = 6)] = 'COMPONENT';\n})(ShapeFlags || (ShapeFlags = {}));\n\nexport const invokeArrayFns = (fns, arg) => {\n  for (let i = 0; i < fns.length; i++) {\n    fns[i](arg);\n  }\n};\n\nfunction invokeVNodeHook(hook, instance, vnode, prevVNode) {\n  callWithAsyncErrorHandling(hook, instance, ErrorCodes.VNODE_HOOK, [vnode, prevVNode]);\n}\n\nconst isSuspense = type => type.__isSuspense;\n\nexport const MoveType = {\n  ENTER: 0,\n  LEAVE: 1,\n  REORDER: 2\n};\n\nexport const ErrorCodes = {\n  SETUP_FUNCTION: 0,\n  RENDER_FUNCTION: 1,\n  WATCH_GETTER: 2,\n  WATCH_CALLBACK: 3,\n  WATCH_CLEANUP: 4,\n  NATIVE_EVENT_HANDLER: 5,\n  COMPONENT_EVENT_HANDLER: 6,\n  VNODE_HOOK: 7\n};\n\nfunction resetShapeFlag(vnode) {\n  // bitwise operations to remove keep alive flags\n  vnode.shapeFlag &= ~ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE;\n  vnode.shapeFlag &= ~ShapeFlags.COMPONENT_KEPT_ALIVE;\n}\n\nfunction getInnerChild(vnode) {\n  return vnode.shapeFlag & ShapeFlags.SUSPENSE ? vnode.ssContent : vnode;\n}\n\nconst stack = [];\n\nconst getIndexByKey = key => {\n  for (let index = 0; index < stack.length; index++) {\n    if (stack[index].key === key) {\n      return index;\n    }\n  }\n  return -1;\n};\n\nconst VuePageStack = keyName => {\n  return defineComponent({\n    name: config.componentName,\n    __isKeepAlive: true,\n    setup(props, { slots }) {\n      console.log('VuePageStack setup', keyName);\n      const instance = getCurrentInstance();\n      const sharedContext = instance.ctx;\n\n      const parentSuspense = instance.suspense;\n\n      const {\n        renderer: {\n          p: patch,\n          m: move,\n          um: _unmount,\n          o: { createElement }\n        }\n      } = sharedContext;\n      const storageContainer = createElement('div');\n\n      sharedContext.activate = (vnode, container, anchor, isSVG, optimized) => {\n        const instance = vnode.component;\n        move(vnode, container, anchor, MoveType.ENTER, parentSuspense);\n        // in case props have changed\n        patch(instance.vnode, vnode, container, anchor, instance, parentSuspense, isSVG, vnode.slotScopeIds, optimized);\n        queuePostFlushCb(() => {\n          instance.isDeactivated = false;\n          if (instance.a) {\n            invokeArrayFns(instance.a);\n          }\n          const vnodeHook = vnode.props && vnode.props.onVnodeMounted;\n          if (vnodeHook) {\n            invokeVNodeHook(vnodeHook, instance.parent, vnode);\n          }\n        }, parentSuspense);\n      };\n\n      sharedContext.deactivate = vnode => {\n        const instance = vnode.component;\n        move(vnode, storageContainer, null, MoveType.LEAVE, parentSuspense);\n        queuePostFlushCb(() => {\n          if (instance.da) {\n            invokeArrayFns(instance.da);\n          }\n          const vnodeHook = vnode.props && vnode.props.onVnodeUnmounted;\n          if (vnodeHook) {\n            invokeVNodeHook(vnodeHook, instance.parent, vnode);\n          }\n          instance.isDeactivated = true;\n        }, parentSuspense);\n      };\n\n      function unmount(vnode) {\n        // reset the shapeFlag so it can be properly unmounted\n        resetShapeFlag(vnode);\n        _unmount(vnode, instance, parentSuspense, true);\n      }\n\n      // cache sub tree after render\n      let pendingCacheKey = null;\n      let useCache = false;\n\n      const cacheSubtree = () => {\n        // fix #1621, the pendingCacheKey could be 0\n        console.log('cacheSubtree');\n        if (pendingCacheKey != null) {\n          if (useCache) {\n            stack[stack.length - 1].vnode = getInnerChild(instance.subTree);\n          } else {\n            stack.push({ key: pendingCacheKey, vnode: getInnerChild(instance.subTree) });\n          }\n        }\n        console.log(pendingCacheKey, stack);\n      };\n      onMounted(cacheSubtree);\n      onUpdated(cacheSubtree);\n\n      // clear all cache\n      onBeforeUnmount(() => {\n        for (const cachedStack of stack) {\n          unmount(cachedStack.vnode);\n        }\n      });\n\n      return () => {\n        console.log('return');\n        pendingCacheKey = null;\n        useCache = false;\n        // 这里可以访问到route\n        const route = useRoute();\n        console.log(route);\n\n        // 路由上的Key\n        const key = route.query[keyName];\n\n        if (!slots.default) {\n          return null;\n        }\n\n        console.log(180);\n\n        const children = slots.default();\n        const rawVNode = children[0];\n        if (children.length > 1) {\n          return children;\n        } else if (\n          !isVNode(rawVNode) ||\n          (!(rawVNode.shapeFlag & ShapeFlags.STATEFUL_COMPONENT) && !(rawVNode.shapeFlag & ShapeFlags.SUSPENSE))\n        ) {\n          return rawVNode;\n        }\n\n        console.log(191);\n\n        let vnode = getInnerChild(rawVNode);\n\n        // clone vnode if it's reused because we are going to mutate it\n        if (vnode.el) {\n          vnode = cloneVNode(vnode);\n          if (rawVNode.shapeFlag & ShapeFlags.SUSPENSE) {\n            rawVNode.ssContent = vnode;\n          }\n        }\n\n        pendingCacheKey = key;\n\n        console.log('pendingCacheKey', pendingCacheKey);\n\n        let index = getIndexByKey(key);\n        if (index !== -1) {\n          // vnode.componentInstance = stack[index].vnode.componentInstance;\n          const cachedVNode = stack[index].vnode;\n\n          vnode.el = cachedVNode.el;\n          vnode.component = cachedVNode.component;\n          if (vnode.transition) {\n            // recursively update transition hooks on subTree\n            setTransitionHooks(vnode, vnode.transition);\n          }\n          // avoid vnode being mounted as fresh\n          vnode.shapeFlag |= ShapeFlags.COMPONENT_KEPT_ALIVE;\n\n          // destroy the instances that will be spliced\n          for (let i = index + 1; i < stack.length; i++) {\n            stack[i] = null;\n          }\n          stack.splice(index + 1);\n          useCache = true;\n        }\n\n        // avoid vnode being unmounted\n        vnode.shapeFlag |= ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE;\n\n        return isSuspense(rawVNode.type) ? rawVNode : vnode;\n      };\n    }\n  });\n};\n\nfunction getStack() {\n  return stack;\n}\n\nexport { VuePageStack, getIndexByKey, getStack };\n","import { VuePageStack, getIndexByKey } from './components/VuePageStack.js';\n// import { VuePageStack, getIndexByKey } from './components/KeepPageStack.js';\n// import { VuePageStack, getIndexByKey } from './components/KeepPageStack3.3.2.js';\n// import mixin from './mixin';\nimport history from './history';\nimport config from './config/config';\n\nfunction hasKey(query, keyName) {\n  return !!query[keyName];\n}\n\nfunction getKey(str) {\n  return str.replace(/[xy]/g, c => {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nconst VuePageStackPlugin = {\n  install(app, { router, name = config.componentName, keyName = config.keyName }) {\n    if (!router) {\n      throw Error('\\n vue-router is necessary. \\n\\n');\n    }\n    app.component(name, VuePageStack(keyName));\n\n    router.beforeEach((to, from) => {\n      console.log('beforeEach');\n      if (!hasKey(to.query, keyName)) {\n        to.query[keyName] = getKey('xxxxxxxx');\n        const replace = history.action === config.replaceName || !hasKey(from.query, keyName);\n        return {\n          hash: to.hash,\n          path: to.path,\n          name: to.name,\n          params: to.params,\n          query: to.query,\n          meta: to.meta,\n          replace\n        };\n      } else {\n        const index = getIndexByKey(to.query[keyName]);\n        if (index === -1) {\n          to.params[keyName + '-dir'] = config.forwardName;\n          console.log('前进');\n        } else {\n          to.params[keyName + '-dir'] = config.backName;\n          console.log('后退');\n        }\n      }\n    });\n  }\n};\n\nexport default VuePageStackPlugin;\n"],"names":["config","useRoute","ShapeFlags","invokeArrayFns","fns","arg","i","invokeVNodeHook","hook","instance","vnode","prevVNode","callWithAsyncErrorHandling","ErrorCodes","isSuspense","type","MoveType","resetShapeFlag","getInnerChild","stack","getIndexByKey","key","index","VuePageStack","keyName","defineComponent","props","slots","getCurrentInstance","sharedContext","parentSuspense","patch","move","_unmount","createElement","storageContainer","container","anchor","isSVG","optimized","queuePostFlushCb","vnodeHook","unmount","pendingCacheKey","useCache","cacheSubtree","onMounted","onUpdated","onBeforeUnmount","cachedStack","route","children","rawVNode","isVNode","cloneVNode","cachedVNode","setTransitionHooks","hasKey","query","getKey","str","c","r","VuePageStackPlugin","app","router","name","to","from","replace"],"mappings":"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"}